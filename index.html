<!DOCTYPE html>
<html>
<head>
  <title>Ramadan Pen - Optimized</title>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

  <style>
    body {
      margin: 0;
      background: #050301;
      overflow: hidden;
    }

    video {
      position: absolute;
      visibility: hidden;
    }

    canvas {
      position: absolute;
      width: 100%;
      height: 100%;
      transform: scaleX(-1);
    }
  </style>
</head>

<body>
  <video id="vid" autoplay playsinline></video>
  <canvas id="c"></canvas>

<script>
const video = document.getElementById('vid');
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');

let strokes = [];
let currentStroke = [];
let drawing = false;
let shiftPressed = false;
let smoothX = null;
let smoothY = null;

window.addEventListener('keydown', e => {
  if (e.key === 'Shift') shiftPressed = true;
  if (e.code === 'Space') strokes = [];
});

window.addEventListener('keyup', e => {
  if (e.key === 'Shift') shiftPressed = false;
});

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function onResults(results) {

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // رسم الفيديو
  ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

  // طبقة خفيفة شفافة (بدون تعتيم قوي)
  ctx.globalAlpha = 0.25;
  ctx.fillStyle = "#0a0602";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.globalAlpha = 1;

  ctx.strokeStyle = "#F5D061";
  ctx.lineWidth = 5;
  ctx.lineCap = "round";
  ctx.shadowColor = "#F5D061";
  ctx.shadowBlur = 12;

  strokes.forEach(stroke => {
    ctx.beginPath();
    stroke.forEach((p, i) => {
      if (i === 0) ctx.moveTo(p.x, p.y);
      else ctx.lineTo(p.x, p.y);
    });
    ctx.stroke();
  });

  if (results.multiHandLandmarks?.length > 0) {
    const lm = results.multiHandLandmarks[0];
    const tip = lm[8];

    const x = tip.x * canvas.width;
    const y = tip.y * canvas.height;

    if (smoothX === null) {
      smoothX = x;
      smoothY = y;
    } else {
      smoothX += (x - smoothX) * 0.4;
      smoothY += (y - smoothY) * 0.4;
    }

    ctx.beginPath();
    ctx.arc(smoothX, smoothY, 6, 0, 2 * Math.PI);
    ctx.fillStyle = shiftPressed ? "#FFFFFF" : "rgba(245,208,97,0.6)";
    ctx.fill();

    if (shiftPressed) {
      if (!drawing) {
        drawing = true;
        currentStroke = [];
        strokes.push(currentStroke);
      }
      currentStroke.push({ x: smoothX, y: smoothY });
    } else {
      drawing = false;
    }

  } else {
    drawing = false;
    smoothX = null;
  }
}

const hands = new Hands({
  locateFile: file =>
    `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});

hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 1,
  minDetectionConfidence: 0.6,
  minTrackingConfidence: 0.6
});

hands.onResults(onResults);

const camera = new Camera(video, {
  onFrame: async () => {
    await hands.send({ image: video });
  },
  width: 1280,
  height: 720
});

camera.start();
</script>
</body>
</html>
